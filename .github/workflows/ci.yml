name: CI

on:
  push:
    branches:
      - '**'
  pull_request:
    branches:
      - '**'

jobs:
  lint:
    runs-on: self-hosted
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install dependencies
        run: npm install

      - name: Lint frontend
        run: npm run lint:front

      - name: Lint backend
        run: npm run lint:back

  build:
    runs-on: self-hosted
    needs: lint
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install dependencies
        run: npm install

      - name: Build frontend
        run: cd frontend && npm install && npm run build

      - name: Build backend
        run: cd backend && npm install && npm run build

  test:
    runs-on: self-hosted
    needs: build
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install backend dependencies
        run: |
          cd backend
          npm install

      - name: Run backend tests
        run: |
          cd backend
          npm test

  sonar-backend:
    needs: test
    runs-on: self-hosted
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install backend deps
        run: |
          cd backend
          npm i

      - name: SonarCloud Scan
        uses: sonarsource/sonarcloud-github-action@master
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        with:
          args: >
            -Dsonar.organization=melissafrncjrg
            -Dsonar.projectKey=MelissaFrncJrg_DevOps_Course-CloudNativeApplicationCurse
            -Dsonar.sources=backend/src
            -Dsonar.language=js

  docker:
    runs-on: self-hosted
    needs: build
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Build backend image
        run: docker build -t backend-ci ./backend

      - name: Build frontend image
        run: docker build --build-arg VITE_API_BASE_URL=${{ secrets.VITE_API_BASE_URL }} -t frontend-ci ./frontend

      - name: Run backend container (healthcheck)
        run: |
          docker run -d --rm \
            --name backend-ci-test \
            -p 3000:3000 \
            -e DATABASE_URL="postgresql://user:password@localhost:5432/testdb" \
            -e NODE_ENV=production \
            -e PORT=3000 \
            backend-ci

          # Wait for backend to be healthy
          echo "Waiting for backend to start..."
          sleep 10

          for i in {1..20}; do
            if curl -fsS http://localhost:3000/health >/dev/null 2>&1; then
              echo "✓ Backend is healthy"
              docker stop backend-ci-test
              exit 0
            fi
            echo "Attempt $i/20: Waiting for backend..."
            sleep 3
          done

          # If we get here, healthcheck failed
          echo "✗ Backend healthcheck failed"
          docker logs backend-ci-test
          docker stop backend-ci-test
          exit 1

      - name: Run frontend container (healthcheck)
        run: |
          docker run -d --rm \
            --name frontend-ci-test \
            -p 8080:80 \
            frontend-ci

          # Wait for frontend to be healthy
          echo "Waiting for frontend to start..."
          sleep 5

          for i in {1..20}; do
            if curl -fsS http://localhost:8080 >/dev/null 2>&1; then
              echo "✓ Frontend is healthy"
              docker stop frontend-ci-test
              exit 0
            fi
            echo "Attempt $i/20: Waiting for frontend..."
            sleep 3
          done

          # If we get here, healthcheck failed
          echo "✗ Frontend healthcheck failed"
          docker logs frontend-ci-test
          docker stop frontend-ci-test
          exit 1

      - name: Login to GHCR
        run: echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin

      - name: Set lowercase repository owner
        id: repo
        run: echo "owner=$(echo ${{ github.repository_owner }} | tr '[:upper:]' '[:lower:]')" >> $GITHUB_OUTPUT

      - name: Tag and push backend image
        run: |
          docker tag backend-ci ghcr.io/${{ steps.repo.outputs.owner }}/cloudnative-backend:${{ github.sha }}
          docker push ghcr.io/${{ steps.repo.outputs.owner }}/cloudnative-backend:${{ github.sha }}

      - name: Tag and push frontend image
        run: |
          docker tag frontend-ci ghcr.io/${{ steps.repo.outputs.owner }}/cloudnative-frontend:${{ github.sha }}
          docker push ghcr.io/${{ steps.repo.outputs.owner }}/cloudnative-frontend:${{ github.sha }}
